<!DOCTYPE html>
<meta charset="utf-8">
<!-- Copyright 2011 Jason Davies https://github.com/jasondavies/newick.js -->

<head>
    <style>
        body {
            margin: 0;
        }
    </style>
    <script src="//unpkg.com/3d-force-graph"></script>

    <script>
        function parseNewick(a) {
            for (var e = [], r = {}, s = a.split(/\s*(;|\(|\)|,|:)\s*/), t = 0; t < s.length; t++) {
                var n = s[t];
                switch (n) {
                    case "(":
                        var c = {};
                        r.branchset = [c], e.push(r), r = c;
                        break;
                    case ",":
                        var c = {};
                        e[e.length - 1].branchset.push(c), r = c;
                        break;
                    case ")":
                        r = e.pop();
                        break;
                    case ":":
                        break;
                    default:
                        function getRandomInt(max) {
                            return Math.floor(Math.random() * Math.floor(max));
                        }
                        hash = getRandomInt(1000);
                        var h = s[t - 1];
                        ")" == h || "(" == h || "," == h ? r.name = n+hash : ":" == h && (r.length = parseFloat(n))
                }
            }
            return r
        }
    </script>

    <!-- Copyright 2016 Mike Bostock https://d3js.org -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="//unpkg.com/3d-force-graph"></script>
    <script>
        //d3.text("life.txt", function (error, life) {
        d3.text("tree-of-life.txt", function (error, life) {
            //d3.text("https://gist.githubusercontent.com/mbostock/c034d66572fd6bd6815a/raw/98778537e42f5605d9eddae5fba3329d969b813c/life.txt", function (error, life) {
            if (error) throw error;

            var root = d3.hierarchy(parseNewick(life), function (d) {
                    return d.branchset;
                })
                .sum(function (d) {
                    return d.branchset ? 0 : 1;
                })
                .sort(function (a, b) {
                    return (a.value - b.value) || d3.ascending(a.data.length, b.data.length);
                });

            items = new Set();

            linksList = [];
            root.links().forEach(function (value) {
                var source = value.source.data.name;
                var target = value.target.data.name;
                var length = value.target.data.length;
                linksList.push({
                    source: source,
                    target: target,
                    length: length,
                });
                items.add(source);
                items.add(target);
            });


            //const N = 3;
            const M = linksList.length;
            const N = items.size;
            //items.size
            const gData = {
                nodes: [...Array(N).keys()].map(i => ({

                    id: [...items][i]
                })),
                links: [...Array(M).keys()].map(j => ({
                    source: linksList[j].source,
                    target: linksList[j].target,
                    length: linksList[j].length
                })),
            };

            //gData.nodes[0].fx=600;
            //gData.nodes[0].fy=600;
            //gData.nodes[0].fz=600;
            //console.log(gData.nodes[0]);

            // gData.nodes[328].fx=400;
            // gData.nodes[328].fy=400;
            // gData.nodes[328].fz=400;
            // console.log(gData.nodes[328]);

            // gData.nodes[113].fx=-400;
            // gData.nodes[113].fy=400;
            // gData.nodes[113].fz=400;
            // console.log(gData.nodes[113]);

            // gData.nodes[200].fx=400;
            // gData.nodes[200].fy=-400;
            // gData.nodes[200].fz=400;
            // console.log(gData.nodes[200]);

            // gData.nodes[80].fx=-400;
            // gData.nodes[80].fy=-400;
            // gData.nodes[80].fz=400;
            // console.log(gData.nodes[80]);

            // gData.nodes[2].fx=400;
            // gData.nodes[2].fy=400;
            // gData.nodes[2].fz=-400;
            // console.log(gData.nodes[2]);

            // gData.nodes[3].fx=-400;
            // gData.nodes[3].fy=400;
            // gData.nodes[3].fz=-400;
            // console.log(gData.nodes[3]);

            // gData.nodes[4].fx=400;
            // gData.nodes[4].fy=-400;
            // gData.nodes[4].fz=-400;
            // console.log(gData.nodes[4]);

            // gData.nodes[187].fx=700;
            // gData.nodes[187].fy=-700;
            // gData.nodes[187].fz=-700;
            // console.log(gData.nodes[4]);
            
            
            console.log(gData);

            const Graph = ForceGraph3D()
                (document.getElementById('3d-graph'))
                .nodeLabel(node => node.id)
                .graphData(gData)
                //.d3Force('link')
            //     //.distance(link => link.color ? settings.redDistance : settings.greenDistance);
                 //.distance(link => link.length*1)
                 //.distance(link => 5)
                 //.strength(1);
                //.d3force.forceManyBody().strength(100000);

                //console.log(Graph);

             const linkForce = Graph
             //d3.forceManyBody().strength(200).distanceMax(400).distanceMin(60)
             //d3.forceManyBody().strength(-140).distanceMax(50).distanceMin(10)
             //.d3Force('charge').strength(-0.1)
             //.d3.forceManyBody().strength(-10000)
             //.force("center", d3.forceCenter(width / 2, height / 2))
             //.d3Force('collide', d3.forceCollide(70))
             //.d3AlphaDecay(0.01)
             //.d3VelocityDecay(0.1)
             //.d3Force('collide', d3.forceCollide().strength( 10 ).radius(11))
           //d3v4.forceCollide().strength( 10 ).radius(110 * chargeStrength)


                 .d3Force('link')
            //     //.distance(link => link.color ? settings.redDistance : settings.greenDistance);
                 .distance(link => link.length*800)
                 .iterations(1000)
                 .strength(1);

                 //graph.numDimensions(3);

            // setTimeout(function(){ 
            //     gData.nodes[2].fx=null;
            //     gData.nodes[2].fy=null;
            //     gData.nodes[2].fz=null;

            //     console.log(gData.nodes[2].fz);
            // }, 3000);

            //const manyBody = Graph
            //    .d3force.forceManyBody().strength(-100);
                //.distance(link => link.color ? settings.redDistance : settings.greenDistance);
                //.distance(link => link.length*1);

            // function updateLinkDistance() {
            //     linkForce.distance(link => link.color ? settings.redDistance : settings.greenDistance);
            //     graph.numDimensions(3); // Re-heat simulation
            // }

            //updateLinkDistance();

        });
    </script>

</head>

<body>
    <div id="3d-graph"></div>
</body>